#!/usr/bin/env bash
#################################################################
#                                                               #
#             Proton-GE downloader and installer                #
#                         Version: 1.1.1                        #
#                       Copyright (C) 2021                      #
#           Marcelo dos Santos Mafra <msmafra@gmail.com>        #
#       Licensed under the GNU General Public License v3.0      #
#                                                               #
#           https://gitlab.com/msmafra/proton-get               #
#                                                               #
#################################################################

#{{{ Bash settings
set -o errexit
set -o errtrace
set -o nounset
set -o pipefail
# set -o xtrace
#}}}

declare protonget_version
declare which_arg
declare xidel_exec

protonget_version="1.0.1"
which_arg="${1:-}"

if [[ "${which_arg}" =~ -v|--version ]];then
    printf "proton-get version %s\n" "${protonget_version}"
    printf "\n"
    if [[ "$(command -v xidel > /dev/null 2>&1)" ]];then
        xidel_exec="$(command -v xidel > /dev/null 2>&1)"
        "${xidel_exec}" --version
    fi
    exit 0
fi


main() {

    protonGet
    trap exit_stage_left EXIT ERR # Elegant exit

}

exit_stage_left() {

    unset temp_dir xidel_url xidel_file exec_xidel steam_tools_folder ge_releases_url ge_latest ge_proton_file ge_proton_remote ge_proton_local
    printf "\n%s\n" "Bye!"

}

protonGet() {

    local -i user_id
    user_id="$(id --user)"

    if [[ "${user_id}" -ne 0 ]];then

        local temp_dir
        local xidel_url
        local xidel_file
        local exec_xidel
        local steam_tools_folder
        local ge_releases_url
        local ge_latest
        local ge_proton_file
        local ge_proton_remote
        local ge_proton_local

        temp_dir="$(mktemp --directory --suffix=ProtonGet)"

        if [[ ! -f "${HOME}"/.local/bin/xidel ]];then

            # Required
            cd "${temp_dir}" && pwd
            xidel_url="https://github.com/benibela/xidel/releases/download/Xidel_0.9.8/xidel-0.9.8.linux64.tar.gz"
            xidel_file="$(printf "%s" "https://github.com/benibela/xidel/releases/download/Xidel_0.9.8/xidel-0.9.8.linux64.tar.gz" | awk -F"/" '{print $9}')"

            printf "%s\n- %s\n- %s\n" "Xidel not found. Info:" "http://www.videlibri.de/xidel.html" "by Benito van der Zander <benito@benibela.de>"

            printf "%s %s\n" "Downloading xidel 0.9.8 (latest stable at 2021-05-17) to the temporary directory" "${temp_dir}"
            cd "${temp_dir}" && pwd
            wget --quiet --content-disposition --continue "${xidel_url}"

            printf "\n%s\n" "-> Extracting files to ${temp_dir}:"
            cd "${temp_dir}" && pwd
            tar --get --verbose --file "${xidel_file}" --directory="${temp_dir}"

        fi

        if [[ -f "${HOME}"/.local/bin/xidel ]];then

            exec_xidel="${HOME}/.local/bin/xidel"
            printf "\n-> xidel found. using from %s" "${exec_xidel}"

        else

            exec_xidel="${temp_dir}/xidel"
            printf "\n-> xidel found. using from %s" "${exec_xidel}"

        fi
        steam_tools_folder="${HOME}/.local/share/Steam/compatibilitytools.d"
        ge_releases_url="https://github.com/GloriousEggroll/proton-ge-custom/releases"
        ge_latest="$("${exec_xidel}" -s "${ge_releases_url}" --xquery '//a/@href[contains(., ".tar.gz")]' | grep "releases" | awk '{printf "%s%s\n","https://github.com", $1}' | head -n 1)"
        ge_proton_file="$(printf "%s" "${ge_latest}" | awk -F"/" '{print $9}')"
        ge_proton_remote="${ge_proton_file%%.tar*}"
        ge_proton_local="$(find "${steam_tools_folder}/" -maxdepth 1 -name "*Proton*" -type d | awk -F"/" '{print $8}' | sort --reverse | head --lines=1)"

        # Available ones:
        printf "\n-> %s\n" "Available GE releases:"
        "${exec_xidel}" --silent "${ge_releases_url}" --xquery '//a/@href[contains(., ".tar.gz")]' |
        grep "releases" | awk '{printf "%s%s\n","https://github.com", $1}'

        # Current installed ones:
        printf "\n-> %s\n" "Installed GE releases:"
        find "${HOME}"/.local/share/Steam/compatibilitytools.d/ -maxdepth 1 -name "*Proton*" -type d | awk -F"/" '{print $8}' | sort --reverse

        cd "${temp_dir}" && pwd
        # Check if is already installed before download
        if [[ ! ${ge_proton_remote} = "${ge_proton_local}" ]];then

            printf "\n-> A new GE release is available: %s \n%s \n" "${ge_proton_remote}" "${ge_latest}"

            printf "\n-> Downloading using:\nwget --quiet --show-progress --progress=bar --content-disposition --continue %s\n" "${ge_latest}"
            wget --quiet --show-progress --progress=bar --content-disposition --continue "${ge_latest}"

            printf "\n-> Extracting using:\ntar --get --verbose --file %s --directory=%s\n" "${ge_proton_file}" "${steam_tools_folder}"
            tar --get --verbose --file "${ge_proton_file}" --directory="${steam_tools_folder}"

            printf "\n%s was extracted/installed in %s\n" "-> ${ge_proton_file}" "${steam_tools_folder}"
            printf "\n-> All files were downloaded to the temporary folder %s\n" "${temp_dir}"

        else

            printf "\n%s is already installed\n" "${ge_proton_file}"

        fi

    else

        printf "%s\n" "-> Usage of superuser/elevated privileges, is not allowed. Exiting <-"
        exit 1

    fi

}

main "${@}"
